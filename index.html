<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIP Tracker Pro</title>
<style>
:root{
    --bg-color: #121212;
    --card-color: #1e1e1e;
    --text-color: #ffffff;
    --primary-color: #00ff88;
    --offline-color: #ff4d4d;
    --online-color: #00ff88;
    --progress-bg: #333;
    --progress-bar: linear-gradient(90deg, #00ff88, #00ffaa);
}
body{
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    margin:0;
    padding:20px;
}
button{
    cursor:pointer;
    border:none;
    border-radius:5px;
    padding:8px 12px;
    font-weight:bold;
    transition:0.3s;
}
button:hover{opacity:0.8;}
input{
    padding:8px;
    margin:5px 0;
    border-radius:5px;
    border:1px solid #555;
    width:80%;
}
#loginDiv, #trackerDiv{max-width:500px;margin:auto;}
#trackerDiv{display:none;}
.tracker{
    border-radius:12px;
    background: var(--card-color);
    padding:15px;
    margin:12px 0;
    box-shadow:0 4px 15px rgba(0,0,0,0.5);
}
.progress{
    background: var(--progress-bg);
    width:100%;
    height:20px;
    border-radius:10px;
    overflow:hidden;
    margin-top:8px;
}
.progress-bar{
    height:100%;
    width:0%;
    border-radius:10px;
    transition:width 0.5s;
    background: var(--progress-bar);
}
.online{color: var(--online-color); font-weight:bold;}
.offline{color: var(--offline-color); font-weight:bold;}
#themeBtn{
    position:fixed;
    top:20px;
    right:20px;
    background: var(--primary-color);
    color:#000;
}
</style>
</head>
<body>

<button id="themeBtn" onclick="toggleTheme()">تبديل الوضع</button>

<div id="loginDiv">
<h2>تسجيل الدخول</h2>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button onclick="login()">تسجيل الدخول</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<div id="trackerDiv">
<h1>VIP Tracker Pro</h1>
<div>
<input type="text" id="uidInput" placeholder="ادخل UID">
<button onclick="addTracker()">➕ إضافة تتبع</button>
</div>
<h2>الحسابات المتتبعة</h2>
<div id="trackers"></div>
</div>

<script type="module">
// ==========================
// Firebase Initialization
// ==========================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCAj1-O4RBQPP5GOHm9M4JdGey7tgdl7-E",
  authDomain: "vip-tracker-saif.firebaseapp.com",
  databaseURL: "https://vip-tracker-saif-default-rtdb.firebaseio.com",
  projectId: "vip-tracker-saif",
  storageBucket: "vip-tracker-saif.firebasestorage.app",
  messagingSenderId: "877224293250",
  appId: "1:877224293250:web:ecf000a1d6961b948d559b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==========================
// Toggle Dark / Light Mode
// ==========================
function toggleTheme(){
    if(document.body.style.backgroundColor === "white"){
        document.documentElement.style.setProperty('--bg-color','#121212');
        document.documentElement.style.setProperty('--card-color','#1e1e1e');
        document.documentElement.style.setProperty('--text-color','#ffffff');
    } else {
        document.documentElement.style.setProperty('--bg-color','#ffffff');
        document.documentElement.style.setProperty('--card-color','#f2f2f2');
        document.documentElement.style.setProperty('--text-color','#000000');
    }
}

// ==========================
// Login Function
// ==========================
function login(){
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    const msg = document.getElementById('loginMsg');

    if(user==="saif2026" && pass==="saif2008"){
        document.getElementById('loginDiv').style.display="none";
        document.getElementById('trackerDiv').style.display="block";
        loadGlobalTrackers();
    } else {
        msg.textContent="يوزر أو كلمة سر خاطئة!";
    }
}

// ==========================
// حساب EXP المطلوب للفل التالي
// ==========================
function getRequiredExp(level){
    return 1000 + (level * 500);
}

// ==========================
// Global Trackers Array
// ==========================
let trackers = [];

// Load trackers from Firebase DB
async function loadGlobalTrackers() {
    const snapshot = await get(child(ref(db), 'trackers'));
    if(snapshot.exists()){
        trackers = Object.values(snapshot.val());
        loadTrackers();
    }
}

// ==========================
// إضافة UID للتتبع
// ==========================
async function addTracker(){
    const uid = document.getElementById('uidInput').value.trim();
    if(!uid) return alert("ادخل UID!");
    if(trackers.find(t=>t.uid===uid)) return alert("تم تتبع هذا الحساب مسبقاً");

    const tracker = {
        uid: uid,
        nickname: "جارِ التحميل...",
        level: 0,
        exp: 0,
        oldExp: 0,
        oldLevel: 0,
        online: true
    };

    trackers.push(tracker);
    await set(ref(db, 'trackers/' + uid), tracker); 
    loadTrackers();
    document.getElementById('uidInput').value = "";
}

// ==========================
// حذف UID من التتبع
// ==========================
async function deleteTracker(uid){
    trackers = trackers.filter(t=>t.uid!==uid);
    await set(ref(db, 'trackers/' + uid), null);
    loadTrackers();
}

// ==========================
// تحميل وتتبع الحسابات
// ==========================
function loadTrackers(){
    const trackersDiv = document.getElementById("trackers");
    trackersDiv.innerHTML="";

    trackers.forEach(tracker=>{
        let div=document.createElement("div");
        div.className="tracker";
        div.id="tracker_"+tracker.uid;

        div.innerHTML=`
            <h3>UID: ${tracker.uid} <span id="status_${tracker.uid}" class="${tracker.online?'online':'offline'}">${tracker.online?'Online':'Offline'}</span></h3>
            <p>الاسم: <span id="name_${tracker.uid}">${tracker.nickname}</span></p>
            <p>Level: <span id="level_${tracker.uid}">${tracker.level}</span></p>
            <p>EXP: <span id="exp_${tracker.uid}">${tracker.exp}</span></p>
            <p>زيادة EXP: <span id="diffExp_${tracker.uid}">0</span></p>
            <p>زيادة Level: <span id="diffLevel_${tracker.uid}">0</span></p>
            <div class="progress">
                <div class="progress-bar" id="bar_${tracker.uid}"></div>
            </div>
            <button onclick="deleteTracker('${tracker.uid}')">❌ حذف التتبع</button>
        `;
        trackersDiv.appendChild(div);

        startLiveTracking(tracker);
    });
}

// ==========================
// التتبع الحي لكل حساب
// ==========================
function startLiveTracking(tracker){
    if(tracker.interval) clearInterval(tracker.interval);
    tracker.interval = setInterval(async ()=>{
        try {
            const res = await fetch(`https://ch9ayfa-info-v10-production.up.railway.app/get?uid=${tracker.uid}`);
            const data = await res.json();
            const info = data.data.basicInfo;

            tracker.nickname = info.nickname;
            const oldExp = tracker.exp;
            const oldLevel = tracker.level;

            tracker.exp = info.exp;
            tracker.level = info.level;

            tracker.online = data && data.data && data.data.basicInfo ? true : false;

            document.getElementById("name_"+tracker.uid).textContent = tracker.nickname;
            document.getElementById("level_"+tracker.uid).textContent = tracker.level;
            document.getElementById("exp_"+tracker.uid).textContent = tracker.exp;
            document.getElementById("diffExp_"+tracker.uid).textContent = tracker.exp - oldExp;
            document.getElementById("diffLevel_"+tracker.uid).textContent = tracker.level - oldLevel;
            document.getElementById("status_"+tracker.uid).textContent = tracker.online?'Online':'Offline';
            document.getElementById("status_"+tracker.uid).className = tracker.online?'online':'offline';

            const requiredExp = getRequiredExp(tracker.level);
            const currentLevelBaseExp = tracker.exp - (tracker.exp % requiredExp);
            let percent = ((tracker.exp - currentLevelBaseExp) / requiredExp) * 100;
            if(percent>100) percent=100;
            if(percent<0) percent=0;
            document.getElementById("bar_"+tracker.uid).style.width = percent + "%";

            await set(ref(db, 'trackers/' + tracker.uid), tracker);

        } catch(err){
            tracker.online = false;
            document.getElementById("status_"+tracker.uid).textContent = "Offline";
            document.getElementById("status_"+tracker.uid).className = "offline";
        }
    }, 60000);
}
</script>
</body>
</html>